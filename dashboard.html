<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dashboard — HS CRM</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#0b1220;color:#e5e7eb}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .card{background:#111827;border:1px solid #1f2937;border-radius:12px;padding:12px}
  </style>
</head>
<body>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <div class="wrap">
    <h1>Dashboard (Somente administradores)</h1>
    <div id="err" class="card" style="display:none">Erro ao carregar.</div>
    <div id="cards" class="cards"></div>
    <p><a href="/">← Voltar</a></p>
  </div>
  <script type="module">
    import { ensureIdentity } from './ui/auth.js';
    const user = await ensureIdentity();
    async function getAdmin(){
      const r = await fetch('/api/env_public'); return r.json();
    }
    const env = await getAdmin();
    if(!user || user.email !== env.ADMIN_EMAIL){
      document.getElementById('err').style.display='block';
      document.getElementById('err').textContent='Acesso negado. Entre com o e-mail do administrador.';
      throw new Error('forbidden');
    }
    const res = await fetch('/api/stats_funnel',{method:'POST'}); 
    const data = await res.json();
    const c = document.getElementById('cards');
    function add(label,val){ const d=document.createElement('div'); d.className='card'; d.innerHTML=`<h3>${label}</h3><div style="font-size:28px;font-weight:700">`+val+`</div>`; c.appendChild(d); }
    add('Oferecer', data.funnel.OFFER||0);
    add('Prospectar', data.funnel.PROSPECT||0);
    add('Visitar', data.funnel.VISIT||0);
    add('Vender', data.funnel.WIN||0);
    add('Ticket médio (R$)', (data.avg || 0).toLocaleString());
    const rc = await fetch('/api/stats_commissions',{method:'POST'}).then(r=>r.json());
    add('Comissão gerada (R$)', (rc.totalCommission||0).toLocaleString());
    add('Parcelas a receber (R$)', (rc.futureToReceive||0).toLocaleString());
  </script>
</body>
</html>
