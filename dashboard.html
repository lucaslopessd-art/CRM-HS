<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HS CRM — Dashboard</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/darkly/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/assets/ui.css">
  <style>.chart-wrap{border:1px solid var(--bs-border-color);border-radius:.75rem;padding:1rem}</style>
</head>
<body>
  <div id="app"></div>

  <template id="raw">
    <div id="adminOnly"></div>
    <div class="row g-3">
      <div class="col-6 col-md-3"><div class="kpi"><div class="text-body-secondary small">Oferecimentos</div><div id="kpiOffer" class="value">0</div></div></div>
      <div class="col-6 col-md-3"><div class="kpi"><div class="text-body-secondary small">Prospectar</div><div id="kpiProspect" class="value">0</div></div></div>
      <div class="col-6 col-md-3"><div class="kpi"><div class="text-body-secondary small">Visitas</div><div id="kpiVisit" class="value">0</div></div></div>
      <div class="col-6 col-md-3"><div class="kpi"><div class="text-body-secondary small">Vendas</div><div id="kpiSell" class="value">0</div></div></div>
    </div>

    <div class="row g-3 mt-1">
      <div class="col-12 col-lg-6"><div class="chart-wrap"><canvas id="funnelChart" height="160"></canvas></div></div>
      <div class="col-12 col-lg-6"><div class="chart-wrap"><canvas id="convChart" height="160"></canvas></div></div>
    </div>
  </template>

  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script type="module">
    import { renderShell } from '/assets/ui.js';
    const content = document.getElementById('raw')?.innerHTML || '';
    renderShell({ active: 'dashboard', content });

    // Gate básico de admin (ajuste a lista conforme necessário)
    const ALLOW = ['lucaslopessd@gmail.com'];
    const u = window.netlifyIdentity?.currentUser();
    if (!ALLOW.includes(u?.email || '')) {
      document.getElementById('adminOnly').innerHTML =
        `<div class="alert alert-warning mb-3">Somente administradores.</div>`;
    }

    // Dados do pipeline (do localStorage, para demo)
    const data = JSON.parse(localStorage.getItem('hscrm_pipeline')||'[]');
    const offer = data.filter(d=>d.stage==='offer').length;
    const prospect = data.filter(d=>d.stage==='prospect').length;
    const visit = data.filter(d=>d.stage==='visit').length;
    const sell = data.filter(d=>d.stage==='sell').length;

    document.getElementById('kpiOffer').textContent = offer;
    document.getElementById('kpiProspect').textContent = prospect;
    document.getElementById('kpiVisit').textContent = visit;
    document.getElementById('kpiSell').textContent = sell;

    const funnel = new Chart(document.getElementById('funnelChart'), {
      type: 'bar',
      data: {
        labels: ['Oferecer','Prospectar','Visitar','Vender'],
        datasets: [{ label:'Etapas', data:[offer,prospect,visit,sell] }]
      },
      options:{ plugins:{legend:{display:false}}, responsive:true, maintainAspectRatio:false }
    });

    const conv = (from,to)=> from? Math.round((to/from)*100):0;
    const convChart = new Chart(document.getElementById('convChart'), {
      type: 'bar',
      data: {
        labels: ['Offer→Prospect','Prospect→Visita','Visita→Venda'],
        datasets: [{ label:'Conversão %', data:[
          conv(offer,prospect), conv(prospect,visit), conv(visit,sell)
        ] }]
      },
      options:{ plugins:{legend:{display:false}}, responsive:true, maintainAspectRatio:false, scales:{ y:{ ticks:{ callback:v=>v+'%' } } } }
    });
  </script>
</body>
</html>
