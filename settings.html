<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HS CRM — Configurações</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/darkly/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/assets/ui.css">
</head>
<body>
  <div id="app"></div>

  <template id="raw">
    <div id="adminOnly"></div>

    <h2 class="h4 mb-3">Parâmetros financeiros</h2>

    <div class="row g-3">
      <div class="col-12 col-lg-6">
        <div class="card h-100">
          <div class="card-header d-flex align-items-center gap-2">
            <i class="bi bi-cash-coin"></i><strong>Faixas de comissão</strong>
          </div>
          <div class="card-body">
            <div class="alert alert-secondary small">
              Exemplo inicial:
              <ul class="mb-0">
                <li>R$ 0 a R$ 299.999,99 → <strong>3,50%</strong></li>
                <li>R$ 300.000,00 a R$ 499.999,99 → <strong>3,75%</strong></li>
                <li>≥ R$ 500.000,00 → <strong>4,00%</strong></li>
              </ul>
            </div>
            <label class="form-label">Tabela (JSON)</label>
            <textarea id="faixas" class="form-control" rows="8" spellcheck="false"></textarea>
            <div class="form-text">Formato: [{ "min":0, "max":299999.99, "percent":3.5 }, ...]</div>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-6">
        <div class="card h-100">
          <div class="card-header d-flex align-items-center gap-2">
            <i class="bi bi-wallet2"></i><strong>Pagamentos & Estorno</strong>
          </div>
          <div class="card-body row g-3">
            <div class="col-12">
              <label class="form-label">Parcelamento (vendas ≥ 500k)</label>
              <div class="input-group">
                <span class="input-group-text">Qtd parcelas</span>
                <input type="number" id="parcelasQtd" class="form-control" min="1" value="5">
                <span class="input-group-text">% cada</span>
                <input type="number" id="parcelasPct" class="form-control" step="0.01" value="1.5">
              </div>
              <div class="form-text">Ex: 5 parcelas de 1,5%.</div>
            </div>
            <div class="col-12">
              <label class="form-label">Regra de estorno</label>
              <div class="input-group">
                <span class="input-group-text">Até a parcela nº</span>
                <input type="number" id="estornoAtéParcela" class="form-control" min="1" value="8">
                <span class="input-group-text">estorna</span>
                <input type="number" id="estornoPercent" class="form-control" step="0.01" value="1.5">
                <span class="input-group-text">%</span>
              </div>
              <div class="form-text">Conforme sua regra: se cancelar até a 8ª parcela, estorna 1,5% (primeira comissão paga).</div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12">
        <div class="card">
          <div class="card-header d-flex align-items-center gap-2">
            <i class="bi bi-people"></i><strong>Acessos</strong>
          </div>
          <div class="card-body row g-3">
            <div class="col-12 col-md-6">
              <label class="form-label">Admins (e-mails, separados por vírgula)</label>
              <input id="admins" class="form-control" placeholder="ex.: lucas@exemplo.com, gestao@exemplo.com">
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Gerentes (e-mails, separados por vírgula)</label>
              <input id="managers" class="form-control" placeholder="ex.: gerente@exemplo.com">
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="d-flex gap-2 mt-3">
      <button id="saveCfg" class="btn btn-primary">Salvar</button>
      <button id="resetCfg" class="btn btn-outline-danger">Restaurar padrão</button>
    </div>
  </template>

  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module">
    import { renderShell } from '/assets/ui.js';
    const content = document.getElementById('raw')?.innerHTML || '';
    renderShell({ active: 'config', content });

    // Gate básico
    const ALLOW = ['lucaslopessd@gmail.com'];
    const u = window.netlifyIdentity?.currentUser();
    if (!ALLOW.includes(u?.email || '')) {
      document.getElementById('adminOnly').innerHTML =
        `<div class="alert alert-warning mb-3">Somente administradores.</div>`;
    }

    const LS_KEY = 'hscrm_cfg';
    const padrao = {
      faixas: [
        { min:0, max:299999.99, percent:3.5 },
        { min:300000, max:499999.99, percent:3.75 },
        { min:500000, max:null, percent:4.0 }
      ],
      parcelas:{ qtd:5, pct:1.5 }, // 5 parcelas de 1,5% (quando venda >= 500k)
      estorno:{ ateParcela:8, percent:1.5 }, // cancela até 8ª => estorna 1,5% (1ª comissão)
      admins:['lucaslopessd@gmail.com'],
      managers:[]
    };
    function load(){ try { return JSON.parse(localStorage.getItem(LS_KEY))||padrao; } catch { return padrao; } }
    function save(v){ localStorage.setItem(LS_KEY, JSON.stringify(v)); }

    function render(){
      const cfg = load();
      document.getElementById('faixas').value = JSON.stringify(cfg.faixas, null, 2);
      document.getElementById('parcelasQtd').value = cfg.parcelas.qtd;
      document.getElementById('parcelasPct').value = cfg.parcelas.pct;
      document.getElementById('estornoAtéParcela').value = cfg.estorno.ateParcela;
      document.getElementById('estornoPercent').value = cfg.estorno.percent;
      document.getElementById('admins').value = (cfg.admins||[]).join(', ');
      document.getElementById('managers').value = (cfg.managers||[]).join(', ');
    }
    document.getElementById('saveCfg').onclick = ()=>{
      try {
        const out = {
          faixas: JSON.parse(document.getElementById('faixas').value||'[]'),
          parcelas:{ qtd:Number(document.getElementById('parcelasQtd').value||5), pct:Number(document.getElementById('parcelasPct').value||1.5) },
          estorno:{ ateParcela:Number(document.getElementById('estornoAtéParcela').value||8), percent:Number(document.getElementById('estornoPercent').value||1.5) },
          admins: (document.getElementById('admins').value||'').split(',').map(s=>s.trim()).filter(Boolean),
          managers: (document.getElementById('managers').value||'').split(',').map(s=>s.trim()).filter(Boolean)
        };
        save(out);
        bootstrap.Toast?.getOrCreateInstance(Object.assign(document.createElement('div'),{className:'toast'}));
        alert('Configurações salvas.');
      } catch(e) { alert('JSON das faixas inválido.'); }
    };
    document.getElementById('resetCfg').onclick = ()=>{ localStorage.setItem(LS_KEY, JSON.stringify(padrao)); render(); };
    render();
  </script>
</body>
</html>
